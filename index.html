<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Random Apple Music Song</title>

<style>
body {
    background: #121212;
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    overflow: hidden;
}

.bg {
    position: fixed;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(35px) brightness(0.3);
    transform: scale(1.2);
    transition: background-image 0.4s ease-out;
}

.player {
    position: relative;
    background: rgba(28, 28, 30, 0.65);
    backdrop-filter: blur(20px);
    width: 360px;
    border-radius: 20px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    padding: 20px;
    text-align: center;
    z-index: 2;
}

.album-art {
    width: 100%;
    border-radius: 15px;
    margin-bottom: 15px;
}

.progress-container {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    overflow: hidden;
    margin: 10px 0;
}

.progress {
    height: 100%;
    background: #ff2d55;
    width: 0%;
    transition: width 0.5s;
}

.time {
    font-size: 12px;
    opacity: 0.7;
    display: flex;
    justify-content: space-between;
}

button {
    width: 100%;
    padding: 12px;
    background: #ff2d55;
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 16px;
    cursor: pointer;
}
button:hover {
    background: #ff4f72;
}
</style>

</head>
<body>

<div class="bg" id="bg"></div>

<button id="shuffle">Shuffle</button>

<div id="player" style="display:none;">
    <div id="bg"></div>
    <img id="cover" />
    <div id="info">
        <h2 id="title"></h2>
        <h3 id="artist"></h3>
        <div id="progress">
            <div id="bar"></div>
        </div>
    </div>
</div>

<script>
async function getRandomTrack() {
    try {
        const playlistUrl = "https://embed.music.apple.com/us/playlist/favorite-songs/pl.u-ovURBX17aZ";

        const html = await fetch(playlistUrl)
            .then(r => {
                if (!r.ok) throw new Error("Failed to load playlist (HTTP " + r.status + ")");
                return r.text();
            })
            .catch(err => { throw new Error("Fetch failed: " + err.message) });

        const doc = new DOMParser().parseFromString(html, "text/html");
        const scriptTag = [...doc.querySelectorAll("script")]
            .find(s => s.textContent.includes("songId"));

        if (!scriptTag) throw new Error("Could not find track list in embed");

        const jsonMatch = scriptTag.textContent.match(/"tracks":(\[.*?\])/s);
        if (!jsonMatch) throw new Error("Track data not found in embed");

        let tracks;
        try {
            tracks = JSON.parse(jsonMatch[1]);
        } catch {
            throw new Error("Failed to parse Apple Music JSON");
        }

        if (!tracks.length) throw new Error("Playlist contains no playable songs");

        const track = tracks[Math.floor(Math.random() * tracks.length)];

        return {
            title: track.attributes.name,
            artist: track.attributes.artistName,
            cover: track.attributes.artwork.url
                .replace("{w}", "500")
                .replace("{h}", "500")
        };

    } catch (err) {
        alert("Error: " + err.message);
        console.error(err);
        return null;
    }
}

document.getElementById("shuffle").addEventListener("click", async () => {
    const track = await getRandomTrack();
    if (!track) return;

    document.getElementById("player").style.display = "block";
    document.getElementById("title").textContent = track.title;
    document.getElementById("artist").textContent = track.artist;
    document.getElementById("cover").src = track.cover;

    // background blur
    document.getElementById("bg").style.backgroundImage = `url(${track.cover})`;

    // random progress bar
    const percent = Math.random() * 100;
    document.getElementById("bar").style.width = percent + "%";
});
</script>
</body>
</html>
